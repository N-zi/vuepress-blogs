import{_ as a,o as i,c as l,b as e,d as s,a as n}from"./app-7c879064.js";const r="/vuepress-blogs/images/linux/K8S集群.png",c={},t=e("h2",{id:"k8s",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#k8s","aria-hidden":"true"},"#"),s(" K8S")],-1),o=e("p",null,[e("code",null,"K8S(kubernetes)"),s("是基于容器的集群管理平台 一个K8S系统，通常称为一个k8s集群（Cluster）")],-1),d=e("p",null,"这个集群主要包括两个部分：",-1),u=e("ul",null,[e("li",null,"一个Master节点（主节点）：负责管理和控制"),e("li",null,"一群Node节点（计算节点）：具体的容器")],-1),p=e("div",{class:"custom-container info"},[e("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},[e("g",{fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("circle",{cx:"12",cy:"12",r:"9"}),e("path",{d:"M12 8h.01"}),e("path",{d:"M11 12h1v4h1"})])]),e("p",{class:"custom-container-title"},"INFO"),e("p",null,[e("img",{src:r,alt:"Master节点"})])],-1),m=n(`<h3 id="部署" tabindex="-1"><a class="header-anchor" href="#部署" aria-hidden="true">#</a> 部署</h3><p>部署准备：若干台虚拟机(Oracle VM VirtualBox)</p><h2 id="基本环境配置" tabindex="-1"><a class="header-anchor" href="#基本环境配置" aria-hidden="true">#</a> 基本环境配置</h2><h3 id="_1-关闭selinux" tabindex="-1"><a class="header-anchor" href="#_1-关闭selinux" aria-hidden="true">#</a> 1.关闭selinux</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>setenforce <span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot;</span> /etc/selinux/config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-关闭swap分区或禁用swap文件" tabindex="-1"><a class="header-anchor" href="#_2-关闭swap分区或禁用swap文件" aria-hidden="true">#</a> 2.关闭swap分区或禁用swap文件</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>swapoff <span class="token parameter variable">-a</span>
<span class="token comment"># 注释掉关于swap分区的行</span>
<span class="token function">yes</span> <span class="token operator">|</span> <span class="token function">cp</span> /etc/fstab /etc/fstab_bak
<span class="token function">cat</span> /etc/fstab_bak <span class="token operator">|</span><span class="token function">grep</span> <span class="token parameter variable">-v</span> swap <span class="token operator">&gt;</span> /etc/fstab
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-修改网卡配置" tabindex="-1"><a class="header-anchor" href="#_3-修改网卡配置" aria-hidden="true">#</a> 3.修改网卡配置</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">vim</span> /etc/sysctl.conf <span class="token comment"># 使用其他编辑器也行</span>
net.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span>
net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> <span class="token number">1</span>
net.brddge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>
$ <span class="token function">sysctl</span> <span class="token parameter variable">-p</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-启用内核模块" tabindex="-1"><a class="header-anchor" href="#_4-启用内核模块" aria-hidden="true">#</a> 4.启用内核模块</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ modprobe -- ip_vs
$ modprobe -- ip_vs_rr
$ modprobe -- ip_vs_wrr
$ modprobe -- ip_vs_sh
$ modprobe -- nf_conntrack_ipv4
$ <span class="token function">cut</span> <span class="token parameter variable">-f1</span> <span class="token parameter variable">-d</span> <span class="token string">&quot; &quot;</span>  /proc/modules <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-e</span> ip_vs <span class="token parameter variable">-e</span> nf_conntrack_ipv4
$ <span class="token function">vim</span> /etc/sysconfig/modules/ipvs.modules
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-关闭防火墙" tabindex="-1"><a class="header-anchor" href="#_5-关闭防火墙" aria-hidden="true">#</a> 5.关闭防火墙</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ systemctl stop
$ systemctl disable firewalld
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-配置hosts" tabindex="-1"><a class="header-anchor" href="#_6-配置hosts" aria-hidden="true">#</a> 6.配置hosts</h3><h2 id="kubectl、kubeadm、kubelet的安装" tabindex="-1"><a class="header-anchor" href="#kubectl、kubeadm、kubelet的安装" aria-hidden="true">#</a> kubectl、kubeadm、kubelet的安装</h2><h3 id="添加kubernetes的yum源" tabindex="-1"><a class="header-anchor" href="#添加kubernetes的yum源" aria-hidden="true">#</a> 添加<code>Kubernetes</code>的yum源</h3><p>此处使用alibaba的镜像源</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token variable">$vim</span> /etc/yum.repos.d/kubernetes.repo
<span class="token punctuation">[</span>kubernetes<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>Kubernetes
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">repo_gpgcheck</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
	   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装kubelet、kubeadm、kubectl" tabindex="-1"><a class="header-anchor" href="#安装kubelet、kubeadm、kubectl" aria-hidden="true">#</a> 安装kubelet、kubeadm、kubectl</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet kubeadm kubectl
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="启动kubelet服务" tabindex="-1"><a class="header-anchor" href="#启动kubelet服务" aria-hidden="true">#</a> 启动kubelet服务</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ systemctl <span class="token builtin class-name">enable</span> kubelet
$ systemctl start kubelet
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>此时执行<code>systemctl status kubelet</code>查看服务状态，服务状态应为Error(255),如果是其他错误可使用<code>journalctl -xe</code>查看错误信息</p><h2 id="docker安装和配置" tabindex="-1"><a class="header-anchor" href="#docker安装和配置" aria-hidden="true">#</a> Docker安装和配置</h2><h3 id="docker安装" tabindex="-1"><a class="header-anchor" href="#docker安装" aria-hidden="true">#</a> Docker安装</h3><ul><li>centOS</li></ul>`,26),v=e("div",{class:"custom-container info"},[e("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},[e("g",{fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("circle",{cx:"12",cy:"12",r:"9"}),e("path",{d:"M12 8h.01"}),e("path",{d:"M11 12h1v4h1"})])]),e("p",{class:"custom-container-title"},"设置仓库"),e("div",{class:"language-bash line-numbers-mode","data-ext":"sh"},[e("pre",{class:"language-bash"},[e("code",null,[e("span",{class:"token function"},"curl"),s(),e("span",{class:"token parameter variable"},"-fsSL"),s(" https://get.docker.com "),e("span",{class:"token operator"},"|"),s(),e("span",{class:"token function"},"bash"),s(),e("span",{class:"token parameter variable"},"-s"),s(),e("span",{class:"token function"},"docker"),s(),e("span",{class:"token parameter variable"},"--mirror"),s(` Aliyun
$ `),e("span",{class:"token function"},"sudo"),s(" yum "),e("span",{class:"token function"},"install"),s(),e("span",{class:"token parameter variable"},"-y"),s(" yum-utils "),e("span",{class:"token punctuation"},"\\"),s(`
  device-mapper-persistent-data `),e("span",{class:"token punctuation"},"\\"),s(`
  lvm2
`)])]),e("div",{class:"line-numbers","aria-hidden":"true"},[e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"})])])],-1),b=e("ul",null,[e("li",null,"使用以下命令来设置稳定的仓库。")],-1),k=e("div",{class:"custom-container info"},[e("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},[e("g",{fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("circle",{cx:"12",cy:"12",r:"9"}),e("path",{d:"M12 8h.01"}),e("path",{d:"M11 12h1v4h1"})])]),e("p",{class:"custom-container-title"},"使用官方源地址（比较慢）"),e("div",{class:"language-bash line-numbers-mode","data-ext":"sh"},[e("pre",{class:"language-bash"},[e("code",null,[s("$ "),e("span",{class:"token function"},"sudo"),s(" yum-config-manager "),e("span",{class:"token punctuation"},"\\"),s(`
	--add-repo `),e("span",{class:"token punctuation"},"\\"),s(`
	https://download.docker.com/linux/centos/docker-ce.repo
`)])]),e("div",{class:"line-numbers","aria-hidden":"true"},[e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"})])])],-1),h=e("div",{class:"custom-container info"},[e("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},[e("g",{fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("circle",{cx:"12",cy:"12",r:"9"}),e("path",{d:"M12 8h.01"}),e("path",{d:"M11 12h1v4h1"})])]),e("p",{class:"custom-container-title"},"阿里云"),e("div",{class:"language-bash line-numbers-mode","data-ext":"sh"},[e("pre",{class:"language-bash"},[e("code",null,[s("$ "),e("span",{class:"token function"},"sudo"),s(" yum-config-manager "),e("span",{class:"token punctuation"},"\\"),s(`
	--add-repo `),e("span",{class:"token punctuation"},"\\"),s(`
	https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
`)])]),e("div",{class:"line-numbers","aria-hidden":"true"},[e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"})])])],-1),g=e("div",{class:"custom-container info"},[e("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},[e("g",{fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e("circle",{cx:"12",cy:"12",r:"9"}),e("path",{d:"M12 8h.01"}),e("path",{d:"M11 12h1v4h1"})])]),e("p",{class:"custom-container-title"},"清华大学源"),e("div",{class:"language-bash line-numbers-mode","data-ext":"sh"},[e("pre",{class:"language-bash"},[e("code",null,[s("$ "),e("span",{class:"token function"},"sudo"),s(" yum-config-manager "),e("span",{class:"token punctuation"},"\\"),s(`
	-add-repo `),e("span",{class:"token punctuation"},"\\"),s(`
	https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/centos/docker-ce.repo
`)])]),e("div",{class:"line-numbers","aria-hidden":"true"},[e("div",{class:"line-number"}),e("div",{class:"line-number"}),e("div",{class:"line-number"})])])],-1),f=n(`<ul><li>安装最新版本的 Docker Engine-Community 和 containerd，或者转到下一步安装特定版本：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> yum <span class="token function">install</span> docker-ce docker-ce-cli containerd.io docker-compose-plugin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果提示您接受GPG密钥，请选是。 Docker 安装完默认未启动。并且已经创建好 docker 用户组，但该用户组下没有用户。</p><ul><li>要安装特定版本的Docker Engine-Community，通过其完整的软件包名称安装特定版本，该软件包名称（docker-ce）加上版本字符串（第二列），从第一个冒号（：）一直到第一个连字符，并用连字符（-）分隔。例如：docker-ce-18.09.01.</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> yum <span class="token function">install</span> docker-ce-<span class="token operator">&lt;</span>VERSION_STRING<span class="token operator">&gt;</span> docker-ce-cli-<span class="token operator">&lt;</span>VERSION_STRING<span class="token operator">&gt;</span> containerd.io
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>启动docker</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl start <span class="token function">docker</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>通过运行 hello-world 镜像来验证是否正确安装了 <strong>Docker Engine-Community</strong></li></ul><p><strong>卸载docker</strong></p><p>删除安装包:</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>yum remove docker-ce
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>删除镜像、容器、配置文件等内容：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/lib/docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="docker配置" tabindex="-1"><a class="header-anchor" href="#docker配置" aria-hidden="true">#</a> Docker配置</h3><ul><li>1.配置cgroup-driver为systemd</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 查看cgroup-driver</span>
$ <span class="token function">docker</span> info <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> cgroup
<span class="token comment"># 追加 --exec-opt native.cgroupdriver=systemd 参数</span>
$ <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g&quot;</span> /usr/lib/systemd/system/docker.service
$ systemctl daemon-reload <span class="token comment"># 重新加载服务</span>
$ systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span> <span class="token comment"># 启用dokcer服务</span>
$ systemctl restart <span class="token function">docker</span> <span class="token comment"># 启动docker服务</span>
<span class="token comment"># 或者修改docker配置文件</span>
$ <span class="token function">vim</span> /etc/docker/daemon.json
<span class="token punctuation">{</span>
	<span class="token string">&quot;exec-opts&quot;</span>:<span class="token punctuation">[</span><span class="token string">&quot;native.cgroupdriver=systemd&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>2.预先拉取所需镜像</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 查看kubeadm所需镜像</span>
$ kubeadm config images list
k8s.gcr.io/kube-apiserver:v1.16.3
k8s.gcr.io/kube-controller-manager:v1.16.3
k8s.gcr.io/kube-scheduler:v1.16.3
k8s.gcr.io/kube-proxy:v1.16.3
k8s.gcr.io/pause:3.1
k8s.gcr.io/etcd:3.3.15-0
k8s.gcr.io/coredns:1.6.2
<span class="token comment"># 拉取镜像</span>
$ <span class="token function">docker</span> pull kubeimage/kube-apiserver-amd64:v1.16.3
$ <span class="token function">docker</span> pull kubeimage/kube-controller-manager-amd64:v1.16.3
$ <span class="token function">docker</span> pull kubeimage/kube-scheduler-amd64:v1.16.3
$ <span class="token function">docker</span> pull kubeimage/kube-proxy-amd64:v1.16.3
$ <span class="token function">docker</span> pull kubeimage/pause-amd64:3.1
$ <span class="token function">docker</span> pull kubeimage/etcd-amd64:3.3.15-0
$ <span class="token function">docker</span> pull coredns/coredns:1.6.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>3.对预先拉取的镜像重新打tag</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ <span class="token function">docker</span> tag kubeimage/kube-apiserver-amd64:v1.16.3  k8s.gcr.io/kube-apiserver:v1.16.3
$ <span class="token function">docker</span> tag kubeimage/kube-controller-manager-amd64:v1.16.3  k8s.gcr.io/kube-controller-manager:v1.16.3
$ <span class="token function">docker</span> tag kubeimage/kube-scheduler-amd64:v1.16.3  k8s.gcr.io/kube-scheduler:v1.16.3
$ <span class="token function">docker</span> tag kubeimage/kube-proxy-amd64:v1.16.3 k8s.gcr.io/kube-proxy:v1.16.3
$ <span class="token function">docker</span> tag kubeimage/pause-amd64:3.1 k8s.gcr.io/pause:3.1
$ <span class="token function">docker</span> tag kubeimage/etcd-amd64:3.3.15-0 k8s.gcr.io/etcd:3.3.15-0
$ <span class="token function">docker</span> tag coredns/coredns:1.6.2 k8s.gcr.io/coredns:1.6.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Master节点的配置</p><p><em>以上步骤需要在node节点和master节点执行，当前步骤仅需在master节点执行。</em> Master节点的初始化</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 初始化master节点。</span>
<span class="token comment"># --pod-network-cidr=192.168.0.0/16 指定使用Calico网络</span>
<span class="token comment"># --apiserver-advertise-address=10.0.0.5 指向master节点IP，此处也可以使用hosts</span>
$ kubeadm init --pod-network-cidr<span class="token operator">=</span><span class="token number">10.244</span>.0.0/16 <span class="token punctuation">\\</span>
	--kubernetes-version<span class="token operator">=</span>v1.16.3 <span class="token punctuation">\\</span>
	--apiserver-advertise-address<span class="token operator">=</span><span class="token number">10.0</span>.0.5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,23),x=[t,o,d,u,p,m,v,b,k,h,g,f];function _(w,y){return i(),l("div",null,x)}const M=a(c,[["render",_],["__file","yunweixiangguan.html.vue"]]);export{M as default};
